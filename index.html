<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Stock Analyzer - 株価分析・予測ツール</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="AI技術を活用した株価分析・予測ツール。日本株の価格データ、テクニカル指標、銘柄比較機能を無料で提供。初心者でも使いやすいインターフェース。">
    <meta name="keywords" content="株価分析,AI,投資,テクニカル指標,銘柄比較,日本株,無料ツール">
    <meta name="author" content="AppADayCreator">
    <meta name="robots" content="index, follow">
    
    <!-- OGP Meta Tags -->
    <meta property="og:title" content="AI Stock Analyzer - 株価分析・予測ツール">
    <meta property="og:description" content="AI技術を活用した株価分析・予測ツール。日本株の価格データ、テクニカル指標、銘柄比較機能を無料で提供。">
    <meta property="og:image" content="https://cdn1.genspark.ai/user-upload-image/22_generated/0ebc5aa4-f439-448f-afeb-80a978c508a7">
    <meta property="og:url" content="https://appadaycreator.github.io/ai-stock-analyzer">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="AI Stock Analyzer">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@appadaycreator">
    <meta name="twitter:title" content="AI Stock Analyzer - 株価分析・予測ツール">
    <meta name="twitter:description" content="AI技術を活用した株価分析・予測ツール。日本株の価格データ、テクニカル指標、銘柄比較機能を無料で提供。">
    <meta name="twitter:image" content="https://cdn1.genspark.ai/user-upload-image/22_generated/0ebc5aa4-f439-448f-afeb-80a978c508a7">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://cdn1.genspark.ai/user-upload-image/22_generated/415a2486-eefe-4e49-a887-aade6346d6dd">
    <link rel="apple-touch-icon" href="https://cdn1.genspark.ai/user-upload-image/22_generated/415a2486-eefe-4e49-a887-aade6346d6dd">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e40af">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TXQGZRF9');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Styles -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stock-list-link {
            color: #fff;
            text-decoration: underline;
        }
        
        .search-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e7ff;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            padding-right: 35px;
        }

        .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: #888;
        }

        .clear-btn:hover {
            color: #000;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
        }
        
        .btn {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }
        
        .popular-stocks {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .stock-chip {
            background: #f3f4f6;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .stock-chip:hover {
            background: #e5e7eb;
            border-color: #4f46e5;
        }

        .stock-chip .remove-btn {
            margin-left: 6px;
            color: #888;
            cursor: pointer;
        }

        .stock-chip .remove-btn:hover {
            color: #000;
        }

        .stock-count {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #374151;
        }
        
        .results-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stock-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .info-card h3 {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .positive { color: #059669 !important; }
        .negative { color: #dc2626 !important; }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }
        
        .features-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .share-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .share-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .share-btn {
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            color: white;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .share-btn:hover {
            transform: scale(1.05);
        }
        
        .twitter { background: #1da1f2; }
        .facebook { background: #4267b2; }
        .line { background: #00b900; }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 50px;
            opacity: 0.8;
        }
        
        .footer a {
            color: white;
            text-decoration: underline;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .history-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .history-item:hover {
            background-color: #f9fafb;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }

        .reason-list {
            margin-top: 10px;
            padding-left: 20px;
            text-align: left;
        }

        .reason-list li {
            margin-bottom: 4px;
        }

        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .share-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TXQGZRF9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <header>
        <nav>
            <div class="logo">AI Stock Analyzer</div>
            <div class="menu-toggle" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul id="menu">
                <li><a href="index.html">ホーム</a></li>
                <li><a href="dashboard.html">マーケット概況</a></li>
                <li><a href="stocks.html">銘柄一覧</a></li>
                <li><a href="screener.html">スクリーニング</a></li>
                <li><a href="privacy-policy.html">プライバシーポリシー</a></li>
                <li><a href="terms.html">利用規約</a></li>
                <li><a href="contact.html">お問い合わせ</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🤖 AI Stock Analyzer</h1>
            <p>AIが予測する株価分析ツール - 投資の未来を見通そう</p>
            <p><a href="stocks.html" class="stock-list-link">銘柄一覧はこちら</a></p>
            <p><a href="screener.html" class="stock-list-link">高度なスクリーニングはこちら</a></p>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <h2>📈 銘柄を分析</h2>
            <form id="searchForm" class="search-form">
                <div class="form-group">
                    <label for="stockCode">銘柄コード(複数可・カンマ区切り)</label>
                    <div class="input-wrapper">
                        <input type="text" id="stockCode" placeholder="例: 7203, 6758" required>
                        <button type="button" class="clear-btn" onclick="clearStock()">✕</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="period">分析期間</label>
                    <select id="period">
                        <option value="1mo">1ヶ月</option>
                        <option value="3mo" selected>3ヶ月</option>
                        <option value="6mo">6ヶ月</option>
                        <option value="1y">1年</option>
                    </select>
                </div>
                <button type="submit" class="btn">分析開始</button>
            </form>
            
            <div class="popular-stocks">
                <div class="stock-chip" onclick="setStock('7203')">🚗 トヨタ (7203)</div>
                <div class="stock-chip" onclick="setStock('9984')">💻 ソフトバンクG (9984)</div>
                <div class="stock-chip" onclick="setStock('6758')">📱 ソニー (6758)</div>
                <div class="stock-chip" onclick="setStock('8306')">🏦 三菱UFJ (8306)</div>
                <div class="stock-chip" onclick="setStock('6501')">🔧 日立 (6501)</div>
            </div>
            <p class="stock-count">現在分析可能な銘柄数: <span id="stockCountValue"></span>件</p>
        </div>

        <!-- Favorites Section -->
        <div id="favoritesSection" class="search-section" style="display:none;">
            <h2>⭐ お気に入り銘柄</h2>
            <div id="favoriteList" class="popular-stocks"></div>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>AI分析中...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <h2 id="stockTitle">株価分析結果</h2>
            
            <div class="stock-info" id="stockInfo">
                <!-- 株価情報がここに表示されます -->
            </div>
            
            <div class="chart-container">
                <canvas id="stockChart"></canvas>
            </div>
            
            <div id="aiPrediction" class="info-card" style="margin: 20px 0;">
                <h3>🤖 AI予測</h3>
                <div class="value" id="predictionText">分析中...</div>
            </div>
            <div id="aiReason" class="info-card" style="margin: 20px 0;">
                <h3>📝 AI判断理由</h3>
                <ul id="reasonList" class="reason-list"></ul>
            </div>
            <div style="text-align: right; margin-top: 10px;">
                <button id="favoriteBtn" class="btn" onclick="toggleFavorite(currentStock.code)">☆ お気に入り登録</button>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="history-section" style="display: none;">
            <h2>📊 分析履歴</h2>
            <div id="historyList">
                <!-- 履歴がここに表示されます -->
            </div>
        </div>

        <!-- Features Section -->
        <div class="features-section">
            <div class="feature-card">
                <div class="feature-icon">📊</div>
                <h3>リアルタイム分析</h3>
                <p>最新の株価データを取得し、テクニカル指標を自動計算</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">🤖</div>
                <h3>AI予測機能</h3>
                <p>機械学習アルゴリズムによる価格動向の予測</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">📱</div>
                <h3>モバイル対応</h3>
                <p>スマートフォンでもPC同様の分析が可能</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">💾</div>
                <h3>履歴保存</h3>
                <p>過去の分析結果を保存し、比較分析が可能</p>
            </div>
        </div>

        <!-- Share Section -->
        <div class="share-section">
            <h2>📤 結果をシェア</h2>
            <p>友達と投資の結果を比較しよう！</p>
            <div class="share-buttons">
                <a href="#" class="share-btn twitter" onclick="shareToTwitter()">Twitter でシェア</a>
                <a href="#" class="share-btn facebook" onclick="shareToFacebook()">Facebook でシェア</a>
                <a href="#" class="share-btn line" onclick="shareToLine()">LINE でシェア</a>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>&copy; 2025 AI Stock Analyzer by <a href="https://x.com/appadaycreator" target="_blank">@appadaycreator</a></p>
            <p><a href="privacy-policy.html">プライバシーポリシー</a> | <a href="stocks.html">銘柄一覧</a> | <a href="terms.html">免責事項</a> | <a href="contact.html">お問い合わせ</a></p>
        </div>
    </div>

    <script>
        // グローバル変数
        let stockChart = null;
        let currentStock = null;
        let analysisHistory = JSON.parse(localStorage.getItem('stockAnalysisHistory')) || [];
        let favoriteStocks = JSON.parse(localStorage.getItem('favoriteStocks')) || [];

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            updateStockCount();
            renderFavorites();
            updateFavoriteButton();
            
            // サービスワーカーの登録（PWA対応）
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            }
        });

        // フォーム送信処理
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const stockCode = document.getElementById('stockCode').value.trim();
            const period = document.getElementById('period').value;
            
            if (!stockCode) {
                alert('銘柄コードを入力してください');
                return;
            }
            
            await analyzeStock(stockCode, period);
        });

        // 銘柄設定
        function setStock(code) {
            const input = document.getElementById('stockCode');
            const current = input.value.split(',').map(c => c.trim()).filter(c => c);
            if (!current.includes(code)) {
                current.push(code);
            }
            input.value = current.join(', ');
        }

        function clearStock() {
            document.getElementById('stockCode').value = '';
        }

        // 株価分析メイン関数
        async function analyzeStock(stockCode, period) {
            const codes = stockCode.split(',').map(c => c.trim()).filter(c => c);

            if (codes.length > 1) {
                await analyzeMultipleStocks(codes, period);
                return;
            }

            showLoading(true);

            try {
                const symbol = stockCode + '.T';
                const data = await fetchStockData(symbol, period);

                if (data) {
                    currentStock = {
                        code: stockCode,
                        symbol: symbol,
                        period: period,
                        data: data,
                        analyzedAt: new Date().toISOString()
                    };

                    displayResults(data, stockCode);
                    addToHistory(currentStock);
                    generateAIPrediction(data);
                    generateAIReasoning(data);
                    updateFavoriteButton();
                } else {
                    throw new Error('株価データを取得できませんでした');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('株価データの取得に失敗しました。銘柄コードを確認してください。');
            } finally {
                showLoading(false);
            }
        }

        async function analyzeMultipleStocks(codes, period) {
            showLoading(true);
            currentStock = null;
            updateFavoriteButton();
            try {
                const dataList = await Promise.all(codes.map(c => fetchStockData(c + '.T', period)));
                const datasets = dataList.map((data, idx) => ({
                    code: codes[idx],
                    symbol: codes[idx] + '.T',
                    data: data
                }));
                displayComparisonResults(datasets);
            } catch (error) {
                console.error('Error:', error);
                alert('株価データの取得に失敗しました。銘柄コードを確認してください。');
            } finally {
                showLoading(false);
            }
        }

        // 株価データ取得（モックデータ）
        async function fetchStockData(symbol, period) {
            // 実際の実装では Yahoo Finance API や他の株価APIを使用
            // ここではデモ用のモックデータを生成
            
            await new Promise(resolve => setTimeout(resolve, 2000)); // Loading simulation
            
            const dates = generateDateRange(30);
            const basePrice = 2000 + Math.random() * 1000;
            const prices = [];
            
            for (let i = 0; i < dates.length; i++) {
                const change = (Math.random() - 0.5) * 100;
                const price = Math.max(basePrice + change * (i / dates.length), 100);
                prices.push({
                    date: dates[i],
                    open: price,
                    high: price * (1 + Math.random() * 0.05),
                    low: price * (1 - Math.random() * 0.05),
                    close: price,
                    volume: Math.floor(Math.random() * 1000000) + 100000
                });
            }
            
            return {
                prices: prices,
                info: {
                    name: getStockName(symbol),
                    currentPrice: prices[prices.length - 1].close,
                    change: prices[prices.length - 1].close - prices[prices.length - 2].close,
                    changePercent: ((prices[prices.length - 1].close - prices[prices.length - 2].close) / prices[prices.length - 2].close) * 100,
                    volume: prices[prices.length - 1].volume,
                    marketCap: Math.floor(Math.random() * 10000000000000),
                    per: 15 + Math.random() * 20,
                    pbr: 1 + Math.random() * 3,
                    roe: 5 + Math.random() * 15,
                    dividendYield: Math.random() * 5
                }
            };
        }

        // 日付範囲生成
        function generateDateRange(days) {
            const dates = [];
            const today = new Date();
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            
            return dates;
        }

        const stockNames = {
            '7011.T': '三菱重工業',
            '6146.T': 'ディスコ',
            '6857.T': 'アドバンテスト',
            '8136.T': 'サンリオ',
            '7013.T': 'ＩＨＩ',
            '7012.T': '川崎重工業',
            '1570.T': 'ＮＦ日経レバ',
            '5803.T': 'フジクラ',
            '8035.T': '東京エレクトロン',
            '6920.T': 'レーザーテック',
            '9984.T': 'ソフトバンクグループ',
            '3350.T': 'メタプラネット',
            '5595.T': 'ＱＰＳ研究所',
            '6526.T': 'ソシオネクスト',
            '3903.T': 'ｇｕｍｉ',
            '7014.T': '名村造船所',
            '7974.T': '任天堂',
            '8306.T': '三菱ＵＦＪフィナンシャルＧ',
            '7453.T': '良品計画',
            '215A.T': 'タイミー',
            '7203.T': 'トヨタ自動車',
            '1605.T': 'ＩＮＰＥＸ',
            '4506.T': '住友ファーマ',
            '5246.T': 'ＥＬＥＭＥＮＴＳ',
            '5032.T': 'ＡＮＹＣＯＬＯＲ',
            '9983.T': 'ファーストリテイリング',
            '5597.T': 'ブルーイノベーション',
            '5253.T': 'カバー',
            '8267.T': 'イオン',
            '5801.T': '古河電工',
            '7003.T': '三井Ｅ＆Ｓ',
            '9501.T': '東京電力ＨＤ',
            '1458.T': '楽天２２５ダブルブル',
            '2432.T': 'ディー・エヌ・エー',
            '9101.T': '日本郵船',
            '6098.T': 'リクルートホールディングス',
            '1357.T': 'ＮＦ日経ダブインバ',
            '8411.T': 'みずほフィナンシャルＧ',
            '6861.T': 'キーエンス',
            '8316.T': '三井住友フィナンシャルＧ',
            '6501.T': '日立製作所',
            '6758.T': 'ソニーグループ',
            '3825.T': 'リミックスポイント',
            '5721.T': 'エス・サイエンス',
            '3189.T': 'ＡＮＡＰホールディングス',
            '7692.T': 'アースインフィニティ',
            '6016.T': 'ジャパンエンジンコーポ',
            '3841.T': 'ジーダット',
            '3399.T': '丸千代山岡家',
            '3559.T': 'ピーバンドットコム',
            '4935.T': 'リベルタ',
            '6993.T': '大黒屋ホールディングス',
            '4107.T': '伊勢化学工業',
            '8918.T': 'ランド',
            '2134.T': '北浜キャピタルパートナー',
            '7163.T': '住信ＳＢＩネット銀行',
            '6946.T': '日本アビオニクス',
            '6836.T': 'ぷらっとホーム',
            '6208.T': '石川製作所',
            '6973.T': '協栄産業',
            '2702.T': '日本マクドナルドＨＬＤＧ',
            '3823.T': 'ＴＨＥＷＨＹＨＯＷＤＯ',
            '5889.T': 'ＪＡＰＡＮＥＹＥＷＥＡＲＨＯ',
            '2700.T': '木徳神糧',
            '4222.T': '児玉化学',
            '9348.T': 'ｉｓｐａｃｅ',
            '338A.T': 'ＺＥＮＭＵＴＥＣＨ',
            '2160.T': 'ジーエヌＡＩグループ',
            '3905.T': 'データセクション',
            '5255.T': 'モンスターラボ',
            '278A.T': 'ＴＥＲＲＡＤＲＯＮＥ',
            '6232.T': 'ＡＣＳＬ',
            '153A.T': 'カウリス',
            '4592.T': 'サンバイオ',
            '5616.T': '雨風太陽',
            '219A.T': 'ＨＥＡＲＴＳＥＥＤ',
            '4593.T': 'ヘリオス',
            '218A.T': 'ＬＩＢＥＲＡＷＡＲＥ',
            '3692.T': 'ＦＦＲＩセキュリティ',
            '4584.T': 'キッズウェル・バイオ',
            '247A.T': 'ＡＩロボティクス',
            '9166.T': 'ＧＥＮＤＡ',
            '7201.T': '日産自動車',
            '7267.T': 'ホンダ',
            '6752.T': 'パナソニック ホールディングス',
            '8058.T': '三菱商事',
            '6301.T': 'コマツ',
            '6503.T': '三菱電機',
            '7751.T': 'キヤノン',
            '2503.T': 'キリンホールディングス',
            '2802.T': '味の素',
            '4502.T': '武田薬品工業',
            '4901.T': '富士フイルムホールディングス',
            '5214.T': '日本電気硝子',
            '6305.T': '日立建機',
            '6471.T': '日本精工',
            '6954.T': 'ファナック',
            '7752.T': 'リコー',
            '8031.T': '三井物産',
            '9104.T': '商船三井'
        };

        function getStockName(symbol) {
            return stockNames[symbol] || '銘柄情報';
        }

        function updateStockCount() {
            const count = Object.keys(stockNames).length;
            document.getElementById('stockCountValue').textContent = count;
        }

        // 結果表示
        function displayResults(data, stockCode) {
            const info = data.info;
            const prices = data.prices;
            
            // タイトル更新
            document.getElementById('stockTitle').textContent = `${info.name} (${stockCode}) - 分析結果`;
            
            // 株価情報表示
            const stockInfoHtml = `
                <div class="info-card">
                    <h3>現在価格</h3>
                    <div class="value">${formatNumber(info.currentPrice)}円</div>
                </div>
                <div class="info-card">
                    <h3>前日比</h3>
                    <div class="value ${info.change >= 0 ? 'positive' : 'negative'}">
                        ${info.change >= 0 ? '+' : ''}${formatNumber(info.change)}円
                        (${info.changePercent >= 0 ? '+' : ''}${info.changePercent.toFixed(2)}%)
                    </div>
                </div>
                <div class="info-card">
                    <h3>出来高</h3>
                    <div class="value">${formatVolume(info.volume)}</div>
                </div>
                <div class="info-card">
                    <h3>PER</h3>
                    <div class="value">${info.per.toFixed(2)}倍</div>
                </div>
                <div class="info-card">
                    <h3>PBR</h3>
                    <div class="value">${info.pbr.toFixed(2)}倍</div>
                </div>
                <div class="info-card">
                    <h3>ROE</h3>
                    <div class="value">${info.roe.toFixed(2)}%</div>
                </div>
                <div class="info-card">
                    <h3>配当利回り</h3>
                    <div class="value">${info.dividendYield.toFixed(2)}%</div>
                </div>
                <div class="info-card">
                    <h3>時価総額</h3>
                    <div class="value">${formatMarketCap(info.marketCap)}</div>
                </div>
            `;
            
            document.getElementById('stockInfo').innerHTML = stockInfoHtml;
            
            // チャート描画
            drawChart(prices);
            
            // 結果セクション表示
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // チャート描画
        function drawChart(prices) {
            const ctx = document.getElementById('stockChart').getContext('2d');

            if (stockChart) {
                stockChart.destroy();
            }

            const labels = prices.map(p => new Date(p.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
            const closePrices = prices.map(p => p.close);
            const ma5 = calculateMovingAverage(prices, 5);
            const ma20 = calculateMovingAverage(prices, 20);
            const bb = calculateBollingerBands(prices, 20, 2);

            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '終値',
                            data: closePrices,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '5日MA',
                            data: ma5,
                            borderColor: '#f59e0b',
                            borderWidth: 1.5,
                            fill: false,
                            spanGaps: true,
                            tension: 0.4
                        },
                        {
                            label: '20日MA',
                            data: ma20,
                            borderColor: '#10b981',
                            borderWidth: 1.5,
                            fill: false,
                            spanGaps: true,
                            tension: 0.4
                        },
                        {
                            label: 'BB上部',
                            data: bb.upper,
                            borderColor: '#9ca3af',
                            borderWidth: 1,
                            fill: false,
                            spanGaps: true,
                            borderDash: [4,4],
                            tension: 0.4
                        },
                        {
                            label: 'BB下部',
                            data: bb.lower,
                            borderColor: '#9ca3af',
                            borderWidth: 1,
                            fill: false,
                            spanGaps: true,
                            borderDash: [4,4],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        function displayComparisonResults(datasets) {
            const title = datasets.map(d => `${getStockName(d.symbol)} (${d.code})`).join(' vs ');
            document.getElementById('stockTitle').textContent = title + ' - 比較結果';

            const infoHtml = datasets.map(d => `
                <div class="info-card">
                    <h3>${getStockName(d.symbol)}</h3>
                    <div class="value">${formatNumber(d.data.info.currentPrice)}円</div>
                </div>
            `).join('');

            const portfolioReturn = datasets.reduce((acc, d) => {
                const prices = d.data.prices;
                return acc + (prices[prices.length - 1].close - prices[0].close) / prices[0].close;
            }, 0) / datasets.length;

            const portfolioHtml = `
                <div class="info-card">
                    <h3>ポートフォリオ平均リターン</h3>
                    <div class="value">${(portfolioReturn * 100).toFixed(2)}%</div>
                </div>
            `;

            document.getElementById('stockInfo').innerHTML = infoHtml + portfolioHtml;

            drawComparisonChart(datasets);

            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function drawComparisonChart(datasets) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            if (stockChart) {
                stockChart.destroy();
            }

            const labels = datasets[0].data.prices.map(p => new Date(p.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
            const colors = ['#4f46e5', '#f59e0b', '#10b981', '#ef4444', '#6366f1'];
            const chartDatasets = datasets.map((d, idx) => ({
                label: getStockName(d.symbol),
                data: d.data.prices.map(p => p.close),
                borderColor: colors[idx % colors.length],
                backgroundColor: 'rgba(0,0,0,0)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }));

            stockChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: chartDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: false },
                        x: {}
                    }
                }
            });
        }

        // AI予測生成
        function generateAIPrediction(data) {
            const prices = data.prices;
            const recentPrices = prices.slice(-5).map(p => p.close);
            const trend = calculateTrend(recentPrices);
            
            let prediction = '';
            let confidence = Math.floor(Math.random() * 30) + 60; // 60-90%
            
            if (trend > 0.02) {
                prediction = `📈 上昇トレンド (信頼度: ${confidence}%)`;
            } else if (trend < -0.02) {
                prediction = `📉 下降トレンド (信頼度: ${confidence}%)`;
            } else {
                prediction = `📊 横ばい (信頼度: ${confidence}%)`;
            }
            
            setTimeout(() => {
                document.getElementById('predictionText').textContent = prediction;
            }, 3000);
        }

        function generateAIReasoning(data) {
            const reasons = [];
            const closes = data.prices.map(p => p.close);
            const ma20 = calculateMovingAverage(data.prices, 20).pop();
            const latest = closes[closes.length - 1];
            const trend10 = calculateTrend(closes.slice(-10));

            if (trend10 > 0.02) {
                reasons.push('過去10日間で上昇傾向');
            } else if (trend10 < -0.02) {
                reasons.push('過去10日間で下降傾向');
            }

            if (ma20 && latest > ma20) {
                reasons.push('終値が20日移動平均を上回る');
            } else if (ma20) {
                reasons.push('終値が20日移動平均を下回る');
            }

            if (data.prices.slice(-2)[1].volume > data.prices.slice(-2)[0].volume) {
                reasons.push('直近で出来高が増加');
            }

            const list = document.getElementById('reasonList');
            list.innerHTML = reasons.map(r => `<li>${r}</li>`).join('');
        }

        // トレンド計算
        function calculateTrend(prices) {
            if (prices.length < 2) return 0;
            
            const firstPrice = prices[0];
            const lastPrice = prices[prices.length - 1];
            
            return (lastPrice - firstPrice) / firstPrice;
        }

        // 移動平均計算
        function calculateMovingAverage(prices, period) {
            const result = [];
            for (let i = 0; i < prices.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                    continue;
                }
                let sum = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    sum += prices[j].close;
                }
                result.push(sum / period);
            }
            return result;
        }

        function calculateBollingerBands(prices, period = 20, k = 2) {
            const ma = calculateMovingAverage(prices, period);
            const upper = [];
            const lower = [];
            for (let i = 0; i < prices.length; i++) {
                if (i < period - 1) {
                    upper.push(null);
                    lower.push(null);
                    continue;
                }
                let variance = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    variance += Math.pow(prices[j].close - ma[i], 2);
                }
                const std = Math.sqrt(variance / period);
                upper.push(ma[i] + k * std);
                lower.push(ma[i] - k * std);
            }
            return { upper, lower };
        }

        // 履歴に追加
        function addToHistory(stockData) {
            analysisHistory.unshift(stockData);
            if (analysisHistory.length > 10) {
                analysisHistory = analysisHistory.slice(0, 10);
            }
            
            localStorage.setItem('stockAnalysisHistory', JSON.stringify(analysisHistory));
            loadHistory();
        }

        // 履歴読み込み
        function loadHistory() {
            if (analysisHistory.length === 0) return;
            
            const historyHtml = analysisHistory.map(item => {
                const date = new Date(item.analyzedAt).toLocaleDateString('ja-JP');
                const time = new Date(item.analyzedAt).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="history-item" onclick="loadHistoryItem('${item.code}', '${item.period}')">
                        <strong>${getStockName(item.symbol)} (${item.code})</strong>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            ${date} ${time} - ${item.period}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('historyList').innerHTML = historyHtml;
            document.getElementById('historySection').style.display = 'block';
        }

        // 履歴項目読み込み
        function loadHistoryItem(code, period) {
            document.getElementById('stockCode').value = code;
            document.getElementById('period').value = period;
            analyzeStock(code, period);
        }

        // ローディング表示制御
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // 数値フォーマット
        function formatNumber(num) {
            return new Intl.NumberFormat('ja-JP').format(Math.round(num));
        }

        // 出来高フォーマット
        function formatVolume(volume) {
        if (volume >= 100000000) {
            return (volume / 100000000).toFixed(1) + '億株';
        } else if (volume >= 10000) {
            return (volume / 10000).toFixed(1) + '万株';
        }
        return formatNumber(volume) + '株';
    }

    // 時価総額フォーマット
    function formatMarketCap(marketCap) {
        if (marketCap >= 1000000000000) {
            return (marketCap / 1000000000000).toFixed(1) + '兆円';
        } else if (marketCap >= 100000000) {
            return (marketCap / 100000000).toFixed(0) + '億円';
        }
        return formatNumber(marketCap) + '円';
    }

    // お気に入り管理
    function renderFavorites() {
        const list = document.getElementById('favoriteList');
        if (!list) return;
        list.innerHTML = favoriteStocks.map(code => `
            <div class="stock-chip" onclick="setStock('${code}')">
                ${getStockName(code + '.T')} (${code})
                <span class="remove-btn" onclick="removeFavorite(event, '${code}')">✕</span>
            </div>
        `).join('');
        document.getElementById('favoritesSection').style.display = favoriteStocks.length ? 'block' : 'none';
    }

    function toggleFavorite(code) {
        if (!code) return;
        if (favoriteStocks.includes(code)) {
            favoriteStocks = favoriteStocks.filter(c => c !== code);
        } else {
            favoriteStocks.push(code);
        }
        localStorage.setItem('favoriteStocks', JSON.stringify(favoriteStocks));
        renderFavorites();
    }

    function removeFavorite(e, code) {
        e.stopPropagation();
        favoriteStocks = favoriteStocks.filter(c => c !== code);
        localStorage.setItem('favoriteStocks', JSON.stringify(favoriteStocks));
        renderFavorites();
        updateFavoriteButton();
    }

    function updateFavoriteButton() {
        const btn = document.getElementById('favoriteBtn');
        if (!btn) return;
        if (currentStock && favoriteStocks.includes(currentStock.code)) {
            btn.textContent = '★ お気に入り解除';
        } else {
            btn.textContent = '☆ お気に入り登録';
        }
    }

    // SNSシェア機能
    function shareToTwitter() {
        const text = generateShareText();
        const url = encodeURIComponent(window.location.href);
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${url}&hashtags=継続は力なり,株価分析,AI投資`;
        window.open(twitterUrl, '_blank');
    }

    function shareToFacebook() {
        const url = encodeURIComponent(window.location.href);
        const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        window.open(facebookUrl, '_blank');
    }

    function shareToLine() {
        const text = generateShareText();
        const url = encodeURIComponent(window.location.href);
        const lineUrl = `https://social-plugins.line.me/lineit/share?url=${url}&text=${encodeURIComponent(text)}`;
        window.open(lineUrl, '_blank');
    }

    // シェア用テキスト生成
    function generateShareText() {
        if (!currentStock) {
            return 'AI Stock Analyzer で株価分析をしてみよう！';
        }
        
        const stockName = getStockName(currentStock.symbol);
        const price = formatNumber(currentStock.data.info.currentPrice);
        const change = currentStock.data.info.change >= 0 ? '+' : '';
        const changePercent = currentStock.data.info.changePercent.toFixed(2);
        
        return `🤖AI Stock Analyzerで${stockName}を分析！\n現在価格: ${price}円 (${change}${changePercent}%)\n\n#継続は力なり #株価分析 #AI投資`;
    }

    function toggleMenu() {
        document.getElementById('menu').classList.toggle('active');
    }
</script>
