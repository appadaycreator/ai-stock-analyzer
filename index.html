<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Stock Analyzer - æ ªä¾¡åˆ†æãƒ»äºˆæ¸¬ãƒ„ãƒ¼ãƒ«</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="AIæŠ€è¡“ã‚’æ´»ç”¨ã—ãŸæ ªä¾¡åˆ†æãƒ»äºˆæ¸¬ãƒ„ãƒ¼ãƒ«ã€‚æ—¥æœ¬æ ªã®ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã€ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã€éŠ˜æŸ„æ¯”è¼ƒæ©Ÿèƒ½ã‚’ç„¡æ–™ã§æä¾›ã€‚åˆå¿ƒè€…ã§ã‚‚ä½¿ã„ã‚„ã™ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€‚">
    <meta name="keywords" content="æ ªä¾¡åˆ†æ,AI,æŠ•è³‡,ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™,éŠ˜æŸ„æ¯”è¼ƒ,æ—¥æœ¬æ ª,ç„¡æ–™ãƒ„ãƒ¼ãƒ«">
    <meta name="author" content="AppADayCreator">
    <meta name="robots" content="index, follow">
    
    <!-- OGP Meta Tags -->
    <meta property="og:title" content="AI Stock Analyzer - æ ªä¾¡åˆ†æãƒ»äºˆæ¸¬ãƒ„ãƒ¼ãƒ«">
    <meta property="og:description" content="AIæŠ€è¡“ã‚’æ´»ç”¨ã—ãŸæ ªä¾¡åˆ†æãƒ»äºˆæ¸¬ãƒ„ãƒ¼ãƒ«ã€‚æ—¥æœ¬æ ªã®ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã€ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã€éŠ˜æŸ„æ¯”è¼ƒæ©Ÿèƒ½ã‚’ç„¡æ–™ã§æä¾›ã€‚">
    <meta property="og:image" content="https://cdn1.genspark.ai/user-upload-image/22_generated/0ebc5aa4-f439-448f-afeb-80a978c508a7">
    <meta property="og:url" content="https://appadaycreator.github.io/ai-stock-analyzer">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="AI Stock Analyzer">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@appadaycreator">
    <meta name="twitter:title" content="AI Stock Analyzer - æ ªä¾¡åˆ†æãƒ»äºˆæ¸¬ãƒ„ãƒ¼ãƒ«">
    <meta name="twitter:description" content="AIæŠ€è¡“ã‚’æ´»ç”¨ã—ãŸæ ªä¾¡åˆ†æãƒ»äºˆæ¸¬ãƒ„ãƒ¼ãƒ«ã€‚æ—¥æœ¬æ ªã®ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã€ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã€éŠ˜æŸ„æ¯”è¼ƒæ©Ÿèƒ½ã‚’ç„¡æ–™ã§æä¾›ã€‚">
    <meta name="twitter:image" content="https://cdn1.genspark.ai/user-upload-image/22_generated/0ebc5aa4-f439-448f-afeb-80a978c508a7">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://cdn1.genspark.ai/user-upload-image/22_generated/415a2486-eefe-4e49-a887-aade6346d6dd">
    <link rel="apple-touch-icon" href="https://cdn1.genspark.ai/user-upload-image/22_generated/415a2486-eefe-4e49-a887-aade6346d6dd">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e40af">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TXQGZRF9');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Styles -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stock-list-link {
            color: #fff;
            text-decoration: underline;
        }
        
        .search-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e7ff;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            padding-right: 35px;
        }

        .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: #888;
        }

        .clear-btn:hover {
            color: #000;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
        }
        
        .btn {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }
        
        .popular-stocks {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .stock-chip {
            background: #f3f4f6;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .stock-chip:hover {
            background: #e5e7eb;
            border-color: #4f46e5;
        }

        .stock-chip .remove-btn {
            margin-left: 6px;
            color: #888;
            cursor: pointer;
        }

        .stock-chip .remove-btn:hover {
            color: #000;
        }

        .stock-count {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #374151;
        }
        
        .results-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stock-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .info-card h3 {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .positive { color: #059669 !important; }
        .negative { color: #dc2626 !important; }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }
        
        .features-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .share-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .share-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .share-btn {
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            color: white;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .share-btn:hover {
            transform: scale(1.05);
        }
        
        .twitter { background: #1da1f2; }
        .facebook { background: #4267b2; }
        .line { background: #00b900; }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 50px;
            opacity: 0.8;
        }
        
        .footer a {
            color: white;
            text-decoration: underline;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .history-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .history-item:hover {
            background-color: #f9fafb;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }

        .reason-list {
            margin-top: 10px;
            padding-left: 20px;
            text-align: left;
        }

        .reason-list li {
            margin-bottom: 4px;
        }

        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .share-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TXQGZRF9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <header>
        <nav>
            <div class="logo">AI Stock Analyzer</div>
            <div class="menu-toggle" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul id="menu">
                <li><a href="index.html">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="dashboard.html">ãƒãƒ¼ã‚±ãƒƒãƒˆæ¦‚æ³</a></li>
                <li><a href="stocks.html">éŠ˜æŸ„ä¸€è¦§</a></li>
                <li><a href="screener.html">ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°</a></li>
                <li><a href="privacy-policy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></li>
                <li><a href="terms.html">åˆ©ç”¨è¦ç´„</a></li>
                <li><a href="contact.html">ãŠå•ã„åˆã‚ã›</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¤– AI Stock Analyzer</h1>
            <p>AIãŒäºˆæ¸¬ã™ã‚‹æ ªä¾¡åˆ†æãƒ„ãƒ¼ãƒ« - æŠ•è³‡ã®æœªæ¥ã‚’è¦‹é€šãã†</p>
            <p><a href="stocks.html" class="stock-list-link">éŠ˜æŸ„ä¸€è¦§ã¯ã“ã¡ã‚‰</a></p>
            <p><a href="screener.html" class="stock-list-link">é«˜åº¦ãªã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã¯ã“ã¡ã‚‰</a></p>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <h2>ğŸ“ˆ éŠ˜æŸ„ã‚’åˆ†æ</h2>
            <form id="searchForm" class="search-form">
                <div class="form-group">
                    <label for="stockCode">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰(è¤‡æ•°å¯ãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                    <div class="input-wrapper">
                        <input type="text" id="stockCode" placeholder="ä¾‹: 7203, 6758" required>
                        <button type="button" class="clear-btn" onclick="clearStock()">âœ•</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="period">åˆ†ææœŸé–“</label>
                    <select id="period">
                        <option value="1mo">1ãƒ¶æœˆ</option>
                        <option value="3mo" selected>3ãƒ¶æœˆ</option>
                        <option value="6mo">6ãƒ¶æœˆ</option>
                        <option value="1y">1å¹´</option>
                    </select>
                </div>
                <button type="submit" class="btn">åˆ†æé–‹å§‹</button>
            </form>
            
            <div class="popular-stocks">
                <div class="stock-chip" onclick="setStock('7203')">ğŸš— ãƒˆãƒ¨ã‚¿ (7203)</div>
                <div class="stock-chip" onclick="setStock('9984')">ğŸ’» ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯G (9984)</div>
                <div class="stock-chip" onclick="setStock('6758')">ğŸ“± ã‚½ãƒ‹ãƒ¼ (6758)</div>
                <div class="stock-chip" onclick="setStock('8306')">ğŸ¦ ä¸‰è±UFJ (8306)</div>
                <div class="stock-chip" onclick="setStock('6501')">ğŸ”§ æ—¥ç«‹ (6501)</div>
            </div>
            <p class="stock-count">ç¾åœ¨åˆ†æå¯èƒ½ãªéŠ˜æŸ„æ•°: <span id="stockCountValue"></span>ä»¶</p>
        </div>

        <!-- Favorites Section -->
        <div id="favoritesSection" class="search-section" style="display:none;">
            <h2>â­ ãŠæ°—ã«å…¥ã‚ŠéŠ˜æŸ„</h2>
            <div id="favoriteList" class="popular-stocks"></div>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>AIåˆ†æä¸­...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <h2 id="stockTitle">æ ªä¾¡åˆ†æçµæœ</h2>
            
            <div class="stock-info" id="stockInfo">
                <!-- æ ªä¾¡æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
            
            <div class="chart-container">
                <canvas id="stockChart"></canvas>
            </div>
            
            <div id="aiPrediction" class="info-card" style="margin: 20px 0;">
                <h3>ğŸ¤– AIäºˆæ¸¬</h3>
                <div class="value" id="predictionText">åˆ†æä¸­...</div>
            </div>
            <div id="aiReason" class="info-card" style="margin: 20px 0;">
                <h3>ğŸ“ AIåˆ¤æ–­ç†ç”±</h3>
                <ul id="reasonList" class="reason-list"></ul>
            </div>
            <div style="text-align: right; margin-top: 10px;">
                <button id="favoriteBtn" class="btn" onclick="toggleFavorite(currentStock.code)">â˜† ãŠæ°—ã«å…¥ã‚Šç™»éŒ²</button>
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="history-section" style="display: none;">
            <h2>ğŸ“Š åˆ†æå±¥æ­´</h2>
            <div id="historyList">
                <!-- å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <!-- Features Section -->
        <div class="features-section">
            <div class="feature-card">
                <div class="feature-icon">ğŸ“Š</div>
                <h3>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æ</h3>
                <p>æœ€æ–°ã®æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã‚’è‡ªå‹•è¨ˆç®—</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ¤–</div>
                <h3>AIäºˆæ¸¬æ©Ÿèƒ½</h3>
                <p>æ©Ÿæ¢°å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã‚‹ä¾¡æ ¼å‹•å‘ã®äºˆæ¸¬</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ“±</div>
                <h3>ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ</h3>
                <p>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã‚‚PCåŒæ§˜ã®åˆ†æãŒå¯èƒ½</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ’¾</div>
                <h3>å±¥æ­´ä¿å­˜</h3>
                <p>éå»ã®åˆ†æçµæœã‚’ä¿å­˜ã—ã€æ¯”è¼ƒåˆ†æãŒå¯èƒ½</p>
            </div>
        </div>

        <!-- Share Section -->
        <div class="share-section">
            <h2>ğŸ“¤ çµæœã‚’ã‚·ã‚§ã‚¢</h2>
            <p>å‹é”ã¨æŠ•è³‡ã®çµæœã‚’æ¯”è¼ƒã—ã‚ˆã†ï¼</p>
            <div class="share-buttons">
                <a href="#" class="share-btn twitter" onclick="shareToTwitter()">Twitter ã§ã‚·ã‚§ã‚¢</a>
                <a href="#" class="share-btn facebook" onclick="shareToFacebook()">Facebook ã§ã‚·ã‚§ã‚¢</a>
                <a href="#" class="share-btn line" onclick="shareToLine()">LINE ã§ã‚·ã‚§ã‚¢</a>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>&copy; 2025 AI Stock Analyzer by <a href="https://x.com/appadaycreator" target="_blank">@appadaycreator</a></p>
            <p><a href="privacy-policy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a> | <a href="stocks.html">éŠ˜æŸ„ä¸€è¦§</a> | <a href="terms.html">å…è²¬äº‹é …</a> | <a href="contact.html">ãŠå•ã„åˆã‚ã›</a></p>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let stockChart = null;
        let currentStock = null;
        let analysisHistory = JSON.parse(localStorage.getItem('stockAnalysisHistory')) || [];
        let favoriteStocks = JSON.parse(localStorage.getItem('favoriteStocks')) || [];

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            updateStockCount();
            renderFavorites();
            updateFavoriteButton();
            
            // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç™»éŒ²ï¼ˆPWAå¯¾å¿œï¼‰
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            }
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const stockCode = document.getElementById('stockCode').value.trim();
            const period = document.getElementById('period').value;
            
            if (!stockCode) {
                alert('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            await analyzeStock(stockCode, period);
        });

        // éŠ˜æŸ„è¨­å®š
        function setStock(code) {
            const input = document.getElementById('stockCode');
            const current = input.value.split(',').map(c => c.trim()).filter(c => c);
            if (!current.includes(code)) {
                current.push(code);
            }
            input.value = current.join(', ');
        }

        function clearStock() {
            document.getElementById('stockCode').value = '';
        }

        // æ ªä¾¡åˆ†æãƒ¡ã‚¤ãƒ³é–¢æ•°
        async function analyzeStock(stockCode, period) {
            const codes = stockCode.split(',').map(c => c.trim()).filter(c => c);

            if (codes.length > 1) {
                await analyzeMultipleStocks(codes, period);
                return;
            }

            showLoading(true);

            try {
                const symbol = stockCode + '.T';
                const data = await fetchStockData(symbol, period);

                if (data) {
                    currentStock = {
                        code: stockCode,
                        symbol: symbol,
                        period: period,
                        data: data,
                        analyzedAt: new Date().toISOString()
                    };

                    displayResults(data, stockCode);
                    addToHistory(currentStock);
                    generateAIPrediction(data);
                    generateAIReasoning(data);
                    updateFavoriteButton();
                } else {
                    throw new Error('æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } finally {
                showLoading(false);
            }
        }

        async function analyzeMultipleStocks(codes, period) {
            showLoading(true);
            currentStock = null;
            updateFavoriteButton();
            try {
                const dataList = await Promise.all(codes.map(c => fetchStockData(c + '.T', period)));
                const datasets = dataList.map((data, idx) => ({
                    code: codes[idx],
                    symbol: codes[idx] + '.T',
                    data: data
                }));
                displayComparisonResults(datasets);
            } catch (error) {
                console.error('Error:', error);
                alert('æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } finally {
                showLoading(false);
            }
        }

        // æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼‰
        async function fetchStockData(symbol, period) {
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ Yahoo Finance API ã‚„ä»–ã®æ ªä¾¡APIã‚’ä½¿ç”¨
            // ã“ã“ã§ã¯ãƒ‡ãƒ¢ç”¨ã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            
            await new Promise(resolve => setTimeout(resolve, 2000)); // Loading simulation
            
            const dates = generateDateRange(30);
            const basePrice = 2000 + Math.random() * 1000;
            const prices = [];
            
            for (let i = 0; i < dates.length; i++) {
                const change = (Math.random() - 0.5) * 100;
                const price = Math.max(basePrice + change * (i / dates.length), 100);
                prices.push({
                    date: dates[i],
                    open: price,
                    high: price * (1 + Math.random() * 0.05),
                    low: price * (1 - Math.random() * 0.05),
                    close: price,
                    volume: Math.floor(Math.random() * 1000000) + 100000
                });
            }
            
            return {
                prices: prices,
                info: {
                    name: getStockName(symbol),
                    currentPrice: prices[prices.length - 1].close,
                    change: prices[prices.length - 1].close - prices[prices.length - 2].close,
                    changePercent: ((prices[prices.length - 1].close - prices[prices.length - 2].close) / prices[prices.length - 2].close) * 100,
                    volume: prices[prices.length - 1].volume,
                    marketCap: Math.floor(Math.random() * 10000000000000),
                    per: 15 + Math.random() * 20,
                    pbr: 1 + Math.random() * 3,
                    roe: 5 + Math.random() * 15,
                    dividendYield: Math.random() * 5
                }
            };
        }

        // æ—¥ä»˜ç¯„å›²ç”Ÿæˆ
        function generateDateRange(days) {
            const dates = [];
            const today = new Date();
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            
            return dates;
        }

        const stockNames = {
            '7011.T': 'ä¸‰è±é‡å·¥æ¥­',
            '6146.T': 'ãƒ‡ã‚£ã‚¹ã‚³',
            '6857.T': 'ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆ',
            '8136.T': 'ã‚µãƒ³ãƒªã‚ª',
            '7013.T': 'ï¼©ï¼¨ï¼©',
            '7012.T': 'å·å´é‡å·¥æ¥­',
            '1570.T': 'ï¼®ï¼¦æ—¥çµŒãƒ¬ãƒ',
            '5803.T': 'ãƒ•ã‚¸ã‚¯ãƒ©',
            '8035.T': 'æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³',
            '6920.T': 'ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒƒã‚¯',
            '9984.T': 'ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—',
            '3350.T': 'ãƒ¡ã‚¿ãƒ—ãƒ©ãƒãƒƒãƒˆ',
            '5595.T': 'ï¼±ï¼°ï¼³ç ”ç©¶æ‰€',
            '6526.T': 'ã‚½ã‚·ã‚ªãƒã‚¯ã‚¹ãƒˆ',
            '3903.T': 'ï½‡ï½•ï½ï½‰',
            '7014.T': 'åæ‘é€ èˆ¹æ‰€',
            '7974.T': 'ä»»å¤©å ‚',
            '8306.T': 'ä¸‰è±ï¼µï¼¦ï¼ªãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«ï¼§',
            '7453.T': 'è‰¯å“è¨ˆç”»',
            '215A.T': 'ã‚¿ã‚¤ãƒŸãƒ¼',
            '7203.T': 'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š',
            '1605.T': 'ï¼©ï¼®ï¼°ï¼¥ï¼¸',
            '4506.T': 'ä½å‹ãƒ•ã‚¡ãƒ¼ãƒ',
            '5246.T': 'ï¼¥ï¼¬ï¼¥ï¼­ï¼¥ï¼®ï¼´ï¼³',
            '5032.T': 'ï¼¡ï¼®ï¼¹ï¼£ï¼¯ï¼¬ï¼¯ï¼²',
            '9983.T': 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒªãƒ†ã‚¤ãƒªãƒ³ã‚°',
            '5597.T': 'ãƒ–ãƒ«ãƒ¼ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³',
            '5253.T': 'ã‚«ãƒãƒ¼',
            '8267.T': 'ã‚¤ã‚ªãƒ³',
            '5801.T': 'å¤æ²³é›»å·¥',
            '7003.T': 'ä¸‰äº•ï¼¥ï¼†ï¼³',
            '9501.T': 'æ±äº¬é›»åŠ›ï¼¨ï¼¤',
            '1458.T': 'æ¥½å¤©ï¼’ï¼’ï¼•ãƒ€ãƒ–ãƒ«ãƒ–ãƒ«',
            '2432.T': 'ãƒ‡ã‚£ãƒ¼ãƒ»ã‚¨ãƒŒãƒ»ã‚¨ãƒ¼',
            '9101.T': 'æ—¥æœ¬éƒµèˆ¹',
            '6098.T': 'ãƒªã‚¯ãƒ«ãƒ¼ãƒˆãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹',
            '1357.T': 'ï¼®ï¼¦æ—¥çµŒãƒ€ãƒ–ã‚¤ãƒ³ãƒ',
            '8411.T': 'ã¿ãšã»ãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«ï¼§',
            '6861.T': 'ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹',
            '8316.T': 'ä¸‰äº•ä½å‹ãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«ï¼§',
            '6501.T': 'æ—¥ç«‹è£½ä½œæ‰€',
            '6758.T': 'ã‚½ãƒ‹ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—',
            '3825.T': 'ãƒªãƒŸãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ³ãƒˆ',
            '5721.T': 'ã‚¨ã‚¹ãƒ»ã‚µã‚¤ã‚¨ãƒ³ã‚¹',
            '3189.T': 'ï¼¡ï¼®ï¼¡ï¼°ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹',
            '7692.T': 'ã‚¢ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒ†ã‚£',
            '6016.T': 'ã‚¸ãƒ£ãƒ‘ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³ã‚³ãƒ¼ãƒ',
            '3841.T': 'ã‚¸ãƒ¼ãƒ€ãƒƒãƒˆ',
            '3399.T': 'ä¸¸åƒä»£å±±å²¡å®¶',
            '3559.T': 'ãƒ”ãƒ¼ãƒãƒ³ãƒ‰ãƒƒãƒˆã‚³ãƒ ',
            '4935.T': 'ãƒªãƒ™ãƒ«ã‚¿',
            '6993.T': 'å¤§é»’å±‹ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹',
            '4107.T': 'ä¼Šå‹¢åŒ–å­¦å·¥æ¥­',
            '8918.T': 'ãƒ©ãƒ³ãƒ‰',
            '2134.T': 'åŒ—æµœã‚­ãƒ£ãƒ”ã‚¿ãƒ«ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼',
            '7163.T': 'ä½ä¿¡ï¼³ï¼¢ï¼©ãƒãƒƒãƒˆéŠ€è¡Œ',
            '6946.T': 'æ—¥æœ¬ã‚¢ãƒ“ã‚ªãƒ‹ã‚¯ã‚¹',
            '6836.T': 'ã·ã‚‰ã£ã¨ãƒ›ãƒ¼ãƒ ',
            '6208.T': 'çŸ³å·è£½ä½œæ‰€',
            '6973.T': 'å”æ „ç”£æ¥­',
            '2702.T': 'æ—¥æœ¬ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰ï¼¨ï¼¬ï¼¤ï¼§',
            '3823.T': 'ï¼´ï¼¨ï¼¥ï¼·ï¼¨ï¼¹ï¼¨ï¼¯ï¼·ï¼¤ï¼¯',
            '5889.T': 'ï¼ªï¼¡ï¼°ï¼¡ï¼®ï¼¥ï¼¹ï¼¥ï¼·ï¼¥ï¼¡ï¼²ï¼¨ï¼¯',
            '2700.T': 'æœ¨å¾³ç¥ç³§',
            '4222.T': 'å…ç‰åŒ–å­¦',
            '9348.T': 'ï½‰ï½“ï½ï½ï½ƒï½…',
            '338A.T': 'ï¼ºï¼¥ï¼®ï¼­ï¼µï¼´ï¼¥ï¼£ï¼¨',
            '2160.T': 'ã‚¸ãƒ¼ã‚¨ãƒŒï¼¡ï¼©ã‚°ãƒ«ãƒ¼ãƒ—',
            '3905.T': 'ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³',
            '5255.T': 'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ©ãƒœ',
            '278A.T': 'ï¼´ï¼¥ï¼²ï¼²ï¼¡ï¼¤ï¼²ï¼¯ï¼®ï¼¥',
            '6232.T': 'ï¼¡ï¼£ï¼³ï¼¬',
            '153A.T': 'ã‚«ã‚¦ãƒªã‚¹',
            '4592.T': 'ã‚µãƒ³ãƒã‚¤ã‚ª',
            '5616.T': 'é›¨é¢¨å¤ªé™½',
            '219A.T': 'ï¼¨ï¼¥ï¼¡ï¼²ï¼´ï¼³ï¼¥ï¼¥ï¼¤',
            '4593.T': 'ãƒ˜ãƒªã‚ªã‚¹',
            '218A.T': 'ï¼¬ï¼©ï¼¢ï¼¥ï¼²ï¼¡ï¼·ï¼¡ï¼²ï¼¥',
            '3692.T': 'ï¼¦ï¼¦ï¼²ï¼©ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£',
            '4584.T': 'ã‚­ãƒƒã‚ºã‚¦ã‚§ãƒ«ãƒ»ãƒã‚¤ã‚ª',
            '247A.T': 'ï¼¡ï¼©ãƒ­ãƒœãƒ†ã‚£ã‚¯ã‚¹',
            '9166.T': 'ï¼§ï¼¥ï¼®ï¼¤ï¼¡',
            '7201.T': 'æ—¥ç”£è‡ªå‹•è»Š',
            '7267.T': 'ãƒ›ãƒ³ãƒ€',
            '6752.T': 'ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹',
            '8058.T': 'ä¸‰è±å•†äº‹',
            '6301.T': 'ã‚³ãƒãƒ„',
            '6503.T': 'ä¸‰è±é›»æ©Ÿ',
            '7751.T': 'ã‚­ãƒ¤ãƒãƒ³',
            '2503.T': 'ã‚­ãƒªãƒ³ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹',
            '2802.T': 'å‘³ã®ç´ ',
            '4502.T': 'æ­¦ç”°è–¬å“å·¥æ¥­',
            '4901.T': 'å¯Œå£«ãƒ•ã‚¤ãƒ«ãƒ ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹',
            '5214.T': 'æ—¥æœ¬é›»æ°—ç¡å­',
            '6305.T': 'æ—¥ç«‹å»ºæ©Ÿ',
            '6471.T': 'æ—¥æœ¬ç²¾å·¥',
            '6954.T': 'ãƒ•ã‚¡ãƒŠãƒƒã‚¯',
            '7752.T': 'ãƒªã‚³ãƒ¼',
            '8031.T': 'ä¸‰äº•ç‰©ç”£',
            '9104.T': 'å•†èˆ¹ä¸‰äº•'
        };

        function getStockName(symbol) {
            return stockNames[symbol] || 'éŠ˜æŸ„æƒ…å ±';
        }

        function updateStockCount() {
            const count = Object.keys(stockNames).length;
            document.getElementById('stockCountValue').textContent = count;
        }

        // çµæœè¡¨ç¤º
        function displayResults(data, stockCode) {
            const info = data.info;
            const prices = data.prices;
            
            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            document.getElementById('stockTitle').textContent = `${info.name} (${stockCode}) - åˆ†æçµæœ`;
            
            // æ ªä¾¡æƒ…å ±è¡¨ç¤º
            const stockInfoHtml = `
                <div class="info-card">
                    <h3>ç¾åœ¨ä¾¡æ ¼</h3>
                    <div class="value">${formatNumber(info.currentPrice)}å††</div>
                </div>
                <div class="info-card">
                    <h3>å‰æ—¥æ¯”</h3>
                    <div class="value ${info.change >= 0 ? 'positive' : 'negative'}">
                        ${info.change >= 0 ? '+' : ''}${formatNumber(info.change)}å††
                        (${info.changePercent >= 0 ? '+' : ''}${info.changePercent.toFixed(2)}%)
                    </div>
                </div>
                <div class="info-card">
                    <h3>å‡ºæ¥é«˜</h3>
                    <div class="value">${formatVolume(info.volume)}</div>
                </div>
                <div class="info-card">
                    <h3>PER</h3>
                    <div class="value">${info.per.toFixed(2)}å€</div>
                </div>
                <div class="info-card">
                    <h3>PBR</h3>
                    <div class="value">${info.pbr.toFixed(2)}å€</div>
                </div>
                <div class="info-card">
                    <h3>ROE</h3>
                    <div class="value">${info.roe.toFixed(2)}%</div>
                </div>
                <div class="info-card">
                    <h3>é…å½“åˆ©å›ã‚Š</h3>
                    <div class="value">${info.dividendYield.toFixed(2)}%</div>
                </div>
                <div class="info-card">
                    <h3>æ™‚ä¾¡ç·é¡</h3>
                    <div class="value">${formatMarketCap(info.marketCap)}</div>
                </div>
            `;
            
            document.getElementById('stockInfo').innerHTML = stockInfoHtml;
            
            // ãƒãƒ£ãƒ¼ãƒˆæç”»
            drawChart(prices);
            
            // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // ãƒãƒ£ãƒ¼ãƒˆæç”»
        function drawChart(prices) {
            const ctx = document.getElementById('stockChart').getContext('2d');

            if (stockChart) {
                stockChart.destroy();
            }

            const labels = prices.map(p => new Date(p.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
            const closePrices = prices.map(p => p.close);
            const ma5 = calculateMovingAverage(prices, 5);
            const ma20 = calculateMovingAverage(prices, 20);
            const bb = calculateBollingerBands(prices, 20, 2);

            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'çµ‚å€¤',
                            data: closePrices,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '5æ—¥MA',
                            data: ma5,
                            borderColor: '#f59e0b',
                            borderWidth: 1.5,
                            fill: false,
                            spanGaps: true,
                            tension: 0.4
                        },
                        {
                            label: '20æ—¥MA',
                            data: ma20,
                            borderColor: '#10b981',
                            borderWidth: 1.5,
                            fill: false,
                            spanGaps: true,
                            tension: 0.4
                        },
                        {
                            label: 'BBä¸Šéƒ¨',
                            data: bb.upper,
                            borderColor: '#9ca3af',
                            borderWidth: 1,
                            fill: false,
                            spanGaps: true,
                            borderDash: [4,4],
                            tension: 0.4
                        },
                        {
                            label: 'BBä¸‹éƒ¨',
                            data: bb.lower,
                            borderColor: '#9ca3af',
                            borderWidth: 1,
                            fill: false,
                            spanGaps: true,
                            borderDash: [4,4],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        function displayComparisonResults(datasets) {
            const title = datasets.map(d => `${getStockName(d.symbol)} (${d.code})`).join(' vs ');
            document.getElementById('stockTitle').textContent = title + ' - æ¯”è¼ƒçµæœ';

            const infoHtml = datasets.map(d => `
                <div class="info-card">
                    <h3>${getStockName(d.symbol)}</h3>
                    <div class="value">${formatNumber(d.data.info.currentPrice)}å††</div>
                </div>
            `).join('');

            const portfolioReturn = datasets.reduce((acc, d) => {
                const prices = d.data.prices;
                return acc + (prices[prices.length - 1].close - prices[0].close) / prices[0].close;
            }, 0) / datasets.length;

            const portfolioHtml = `
                <div class="info-card">
                    <h3>ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå¹³å‡ãƒªã‚¿ãƒ¼ãƒ³</h3>
                    <div class="value">${(portfolioReturn * 100).toFixed(2)}%</div>
                </div>
            `;

            document.getElementById('stockInfo').innerHTML = infoHtml + portfolioHtml;

            drawComparisonChart(datasets);

            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function drawComparisonChart(datasets) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            if (stockChart) {
                stockChart.destroy();
            }

            const labels = datasets[0].data.prices.map(p => new Date(p.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
            const colors = ['#4f46e5', '#f59e0b', '#10b981', '#ef4444', '#6366f1'];
            const chartDatasets = datasets.map((d, idx) => ({
                label: getStockName(d.symbol),
                data: d.data.prices.map(p => p.close),
                borderColor: colors[idx % colors.length],
                backgroundColor: 'rgba(0,0,0,0)',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }));

            stockChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: chartDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: false },
                        x: {}
                    }
                }
            });
        }

        // AIäºˆæ¸¬ç”Ÿæˆ
        function generateAIPrediction(data) {
            const prices = data.prices;
            const recentPrices = prices.slice(-5).map(p => p.close);
            const trend = calculateTrend(recentPrices);
            
            let prediction = '';
            let confidence = Math.floor(Math.random() * 30) + 60; // 60-90%
            
            if (trend > 0.02) {
                prediction = `ğŸ“ˆ ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ (ä¿¡é ¼åº¦: ${confidence}%)`;
            } else if (trend < -0.02) {
                prediction = `ğŸ“‰ ä¸‹é™ãƒˆãƒ¬ãƒ³ãƒ‰ (ä¿¡é ¼åº¦: ${confidence}%)`;
            } else {
                prediction = `ğŸ“Š æ¨ªã°ã„ (ä¿¡é ¼åº¦: ${confidence}%)`;
            }
            
            setTimeout(() => {
                document.getElementById('predictionText').textContent = prediction;
            }, 3000);
        }

        function generateAIReasoning(data) {
            const reasons = [];
            const closes = data.prices.map(p => p.close);
            const ma20 = calculateMovingAverage(data.prices, 20).pop();
            const latest = closes[closes.length - 1];
            const trend10 = calculateTrend(closes.slice(-10));

            if (trend10 > 0.02) {
                reasons.push('éå»10æ—¥é–“ã§ä¸Šæ˜‡å‚¾å‘');
            } else if (trend10 < -0.02) {
                reasons.push('éå»10æ—¥é–“ã§ä¸‹é™å‚¾å‘');
            }

            if (ma20 && latest > ma20) {
                reasons.push('çµ‚å€¤ãŒ20æ—¥ç§»å‹•å¹³å‡ã‚’ä¸Šå›ã‚‹');
            } else if (ma20) {
                reasons.push('çµ‚å€¤ãŒ20æ—¥ç§»å‹•å¹³å‡ã‚’ä¸‹å›ã‚‹');
            }

            if (data.prices.slice(-2)[1].volume > data.prices.slice(-2)[0].volume) {
                reasons.push('ç›´è¿‘ã§å‡ºæ¥é«˜ãŒå¢—åŠ ');
            }

            const list = document.getElementById('reasonList');
            list.innerHTML = reasons.map(r => `<li>${r}</li>`).join('');
        }

        // ãƒˆãƒ¬ãƒ³ãƒ‰è¨ˆç®—
        function calculateTrend(prices) {
            if (prices.length < 2) return 0;
            
            const firstPrice = prices[0];
            const lastPrice = prices[prices.length - 1];
            
            return (lastPrice - firstPrice) / firstPrice;
        }

        // ç§»å‹•å¹³å‡è¨ˆç®—
        function calculateMovingAverage(prices, period) {
            const result = [];
            for (let i = 0; i < prices.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                    continue;
                }
                let sum = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    sum += prices[j].close;
                }
                result.push(sum / period);
            }
            return result;
        }

        function calculateBollingerBands(prices, period = 20, k = 2) {
            const ma = calculateMovingAverage(prices, period);
            const upper = [];
            const lower = [];
            for (let i = 0; i < prices.length; i++) {
                if (i < period - 1) {
                    upper.push(null);
                    lower.push(null);
                    continue;
                }
                let variance = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    variance += Math.pow(prices[j].close - ma[i], 2);
                }
                const std = Math.sqrt(variance / period);
                upper.push(ma[i] + k * std);
                lower.push(ma[i] - k * std);
            }
            return { upper, lower };
        }

        // å±¥æ­´ã«è¿½åŠ 
        function addToHistory(stockData) {
            analysisHistory.unshift(stockData);
            if (analysisHistory.length > 10) {
                analysisHistory = analysisHistory.slice(0, 10);
            }
            
            localStorage.setItem('stockAnalysisHistory', JSON.stringify(analysisHistory));
            loadHistory();
        }

        // å±¥æ­´èª­ã¿è¾¼ã¿
        function loadHistory() {
            if (analysisHistory.length === 0) return;
            
            const historyHtml = analysisHistory.map(item => {
                const date = new Date(item.analyzedAt).toLocaleDateString('ja-JP');
                const time = new Date(item.analyzedAt).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="history-item" onclick="loadHistoryItem('${item.code}', '${item.period}')">
                        <strong>${getStockName(item.symbol)} (${item.code})</strong>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            ${date} ${time} - ${item.period}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('historyList').innerHTML = historyHtml;
            document.getElementById('historySection').style.display = 'block';
        }

        // å±¥æ­´é …ç›®èª­ã¿è¾¼ã¿
        function loadHistoryItem(code, period) {
            document.getElementById('stockCode').value = code;
            document.getElementById('period').value = period;
            analyzeStock(code, period);
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatNumber(num) {
            return new Intl.NumberFormat('ja-JP').format(Math.round(num));
        }

        // å‡ºæ¥é«˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatVolume(volume) {
        if (volume >= 100000000) {
            return (volume / 100000000).toFixed(1) + 'å„„æ ª';
        } else if (volume >= 10000) {
            return (volume / 10000).toFixed(1) + 'ä¸‡æ ª';
        }
        return formatNumber(volume) + 'æ ª';
    }

    // æ™‚ä¾¡ç·é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatMarketCap(marketCap) {
        if (marketCap >= 1000000000000) {
            return (marketCap / 1000000000000).toFixed(1) + 'å…†å††';
        } else if (marketCap >= 100000000) {
            return (marketCap / 100000000).toFixed(0) + 'å„„å††';
        }
        return formatNumber(marketCap) + 'å††';
    }

    // ãŠæ°—ã«å…¥ã‚Šç®¡ç†
    function renderFavorites() {
        const list = document.getElementById('favoriteList');
        if (!list) return;
        list.innerHTML = favoriteStocks.map(code => `
            <div class="stock-chip" onclick="setStock('${code}')">
                ${getStockName(code + '.T')} (${code})
                <span class="remove-btn" onclick="removeFavorite(event, '${code}')">âœ•</span>
            </div>
        `).join('');
        document.getElementById('favoritesSection').style.display = favoriteStocks.length ? 'block' : 'none';
    }

    function toggleFavorite(code) {
        if (!code) return;
        if (favoriteStocks.includes(code)) {
            favoriteStocks = favoriteStocks.filter(c => c !== code);
        } else {
            favoriteStocks.push(code);
        }
        localStorage.setItem('favoriteStocks', JSON.stringify(favoriteStocks));
        renderFavorites();
    }

    function removeFavorite(e, code) {
        e.stopPropagation();
        favoriteStocks = favoriteStocks.filter(c => c !== code);
        localStorage.setItem('favoriteStocks', JSON.stringify(favoriteStocks));
        renderFavorites();
        updateFavoriteButton();
    }

    function updateFavoriteButton() {
        const btn = document.getElementById('favoriteBtn');
        if (!btn) return;
        if (currentStock && favoriteStocks.includes(currentStock.code)) {
            btn.textContent = 'â˜… ãŠæ°—ã«å…¥ã‚Šè§£é™¤';
        } else {
            btn.textContent = 'â˜† ãŠæ°—ã«å…¥ã‚Šç™»éŒ²';
        }
    }

    // SNSã‚·ã‚§ã‚¢æ©Ÿèƒ½
    function shareToTwitter() {
        const text = generateShareText();
        const url = encodeURIComponent(window.location.href);
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${url}&hashtags=ç¶™ç¶šã¯åŠ›ãªã‚Š,æ ªä¾¡åˆ†æ,AIæŠ•è³‡`;
        window.open(twitterUrl, '_blank');
    }

    function shareToFacebook() {
        const url = encodeURIComponent(window.location.href);
        const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        window.open(facebookUrl, '_blank');
    }

    function shareToLine() {
        const text = generateShareText();
        const url = encodeURIComponent(window.location.href);
        const lineUrl = `https://social-plugins.line.me/lineit/share?url=${url}&text=${encodeURIComponent(text)}`;
        window.open(lineUrl, '_blank');
    }

    // ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
    function generateShareText() {
        if (!currentStock) {
            return 'AI Stock Analyzer ã§æ ªä¾¡åˆ†æã‚’ã—ã¦ã¿ã‚ˆã†ï¼';
        }
        
        const stockName = getStockName(currentStock.symbol);
        const price = formatNumber(currentStock.data.info.currentPrice);
        const change = currentStock.data.info.change >= 0 ? '+' : '';
        const changePercent = currentStock.data.info.changePercent.toFixed(2);
        
        return `ğŸ¤–AI Stock Analyzerã§${stockName}ã‚’åˆ†æï¼\nç¾åœ¨ä¾¡æ ¼: ${price}å†† (${change}${changePercent}%)\n\n#ç¶™ç¶šã¯åŠ›ãªã‚Š #æ ªä¾¡åˆ†æ #AIæŠ•è³‡`;
    }

    function toggleMenu() {
        document.getElementById('menu').classList.toggle('active');
    }
</script>
